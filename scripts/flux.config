#!/system/bin/sh


# ==============================================================================
# [ Configuration Loading & Validation ]
# ==============================================================================


# ==============================================================================
# [ Directory Structure ]
# ==============================================================================
# Structure
readonly FLUX_DIR="/data/adb/Flux"
readonly BIN_DIR="$FLUX_DIR/bin"
readonly CONF_DIR="$FLUX_DIR/conf"
readonly SCRIPTS_DIR="$FLUX_DIR/scripts"
readonly RUN_DIR="$FLUX_DIR/run"
readonly STATE_DIR="$FLUX_DIR/state"
readonly TOOLS_DIR="$FLUX_DIR/tools"
readonly MAGISK_MOD_DIR="/data/adb/modules/Flux"
# Core Files
readonly SING_BOX_BIN="$BIN_DIR/sing-box"
readonly CONFIG_FILE="$CONF_DIR/config.json"
readonly SETTINGS_FILE="$CONF_DIR/settings.ini"
readonly PID_FILE="$RUN_DIR/sing-box.pid"
readonly LOG_FILE="$RUN_DIR/Flux.log"
# Scripts
readonly TPROXY_SCRIPT="$SCRIPTS_DIR/flux.tproxy"
readonly UPDATE_SCRIPT="$SCRIPTS_DIR/updater.sh"
readonly START_SCRIPT="$SCRIPTS_DIR/start.sh"
# Temporary Files
readonly TMP_SUB_CONVERTED="$RUN_DIR/sub_temp.json"
readonly TMP_NODES_EXTRACTED="$RUN_DIR/nodes.json"
readonly LAST_UPDATE_FILE="$STATE_DIR/.last_update"
readonly GENERATE_FILE="$TOOLS_DIR/generate.ini"
# Module Files
readonly PROP_FILE="$MAGISK_MOD_DIR/module.prop"
# Script-specific files
readonly TEMPLATE_FILE="$TOOLS_DIR/base/singbox.json"
readonly CONFIG_BACKUP="$CONF_DIR/config.json.bak"
# IP Monitor Files
readonly IP_MONITOR_PID_FILE="$RUN_DIR/ip_monitor.pid"
readonly IP_CACHE_FILE="$RUN_DIR/.ip_cache"
# State Files
readonly CORE_READY_FILE="$STATE_DIR/.core_ready"
readonly TPROXY_READY_FILE="$STATE_DIR/.tproxy_ready"
readonly LOCK_FILE="$STATE_DIR/.flux.lock"
readonly LOCK_TIMEOUT=30


# ==============================================================================
# [ Exports & Env ]
# ==============================================================================
# Export for subprocesses
export PATH="$BIN_DIR:/data/adb/magisk:/data/adb/ksu/bin:$PATH"
export FLUX_DIR BIN_DIR CONF_DIR SCRIPTS_DIR RUN_DIR STATE_DIR TOOLS_DIR
# Network Configuration
readonly USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"


# ==============================================================================
# [ Default Settings ]
# ==============================================================================

# Subscription Settings
readonly DEFAULT_SUBSCRIPTION_URL=""
# Shell & System Settings
readonly DEFAULT_LOG_ENABLE=1
readonly DEFAULT_LOG_LEVEL=1
readonly DEFAULT_LOG_MAX_SIZE=1048576
readonly DEFAULT_CORE_TIMEOUT=10
readonly DEFAULT_UPDATE_TIMEOUT=15
readonly DEFAULT_RETRY_COUNT=3
readonly DEFAULT_UPDATE_INTERVAL=86400
# TProxy Default Settings
readonly DEFAULT_CORE_USER="root"
readonly DEFAULT_CORE_GROUP="root"
readonly DEFAULT_ROUTING_MARK=""
readonly DEFAULT_PROXY_TCP_PORT="1536"
readonly DEFAULT_PROXY_UDP_PORT="1536"
readonly DEFAULT_PROXY_MODE=0
readonly DEFAULT_DNS_HIJACK_ENABLE=1
readonly DEFAULT_DNS_PORT="1053"
# Interface Defaults
readonly DEFAULT_MOBILE_INTERFACE="rmnet_data+"
readonly DEFAULT_WIFI_INTERFACE="wlan0"
readonly DEFAULT_HOTSPOT_INTERFACE="wlan2"
readonly DEFAULT_USB_INTERFACE="rndis+"
# Proxy Scope Defaults
readonly DEFAULT_PROXY_MOBILE=1
readonly DEFAULT_PROXY_WIFI=1
readonly DEFAULT_PROXY_HOTSPOT=0
readonly DEFAULT_PROXY_USB=0
readonly DEFAULT_PROXY_TCP=1
readonly DEFAULT_PROXY_UDP=1
readonly DEFAULT_PROXY_IPV6=0
# Internal Marks & IDs
readonly DEFAULT_MARK_VALUE=20
readonly DEFAULT_MARK_VALUE6=25
readonly DEFAULT_TABLE_ID=2025
# App Proxy Defaults
readonly DEFAULT_APP_PROXY_ENABLE=0
readonly DEFAULT_PROXY_APPS_LIST=""
readonly DEFAULT_BYPASS_APPS_LIST=""
readonly DEFAULT_APP_PROXY_MODE=1
# CN IP Bypass Defaults
readonly DEFAULT_BYPASS_CN_IP=0
readonly DEFAULT_CN_IP_FILE="$RUN_DIR/cn.zone"
readonly DEFAULT_CN_IPV6_FILE="$RUN_DIR/cn_ipv6.zone"
readonly DEFAULT_CN_IP_URL="https://raw.githubusercontent.com/Hackl0us/GeoIP2-CN/release/CN-ip-cidr.txt"
readonly DEFAULT_CN_IPV6_URL="https://ispip.clang.cn/all_cn_ipv6.txt"
# MAC Filter Defaults
readonly DEFAULT_MAC_FILTER_ENABLE=0
readonly DEFAULT_PROXY_MACS_LIST=""
readonly DEFAULT_BYPASS_MACS_LIST=""
readonly DEFAULT_MAC_PROXY_MODE="1"
# Feature Check Defaults
readonly DEFAULT_SKIP_CHECK_FEATURE=0
# FakeIP Range Defaults (used when config.json reading fails)
readonly DEFAULT_FAKEIP_RANGE_V4="198.18.0.0/15"
readonly DEFAULT_FAKEIP_RANGE_V6="fc00::/18"


# ==============================================================================
# [ Config Loading ]
# ==============================================================================

load_flux_config() {
    if [ -f "$SETTINGS_FILE" ]; then
        set -a
        . "$SETTINGS_FILE"
        set +a
    fi
    
    SUBSCRIPTION_URL="${SUBSCRIPTION_URL:-$DEFAULT_SUBSCRIPTION_URL}"
    CORE_TIMEOUT="${CORE_TIMEOUT:-$DEFAULT_CORE_TIMEOUT}"
    UPDATE_TIMEOUT="${UPDATE_TIMEOUT:-$DEFAULT_UPDATE_TIMEOUT}"
    UPDATE_INTERVAL="${UPDATE_INTERVAL:-$DEFAULT_UPDATE_INTERVAL}"
    RETRY_COUNT="${RETRY_COUNT:-$DEFAULT_RETRY_COUNT}"
    LOG_ENABLE="${LOG_ENABLE:-$DEFAULT_LOG_ENABLE}"
    LOG_LEVEL="${LOG_LEVEL:-$DEFAULT_LOG_LEVEL}"
    LOG_MAX_SIZE="${LOG_MAX_SIZE:-$DEFAULT_LOG_MAX_SIZE}"
    CORE_USER="${CORE_USER:-$DEFAULT_CORE_USER}"
    CORE_GROUP="${CORE_GROUP:-$DEFAULT_CORE_GROUP}"
    ROUTING_MARK="${ROUTING_MARK:-$DEFAULT_ROUTING_MARK}"
    PROXY_TCP_PORT="${PROXY_TCP_PORT:-$DEFAULT_PROXY_TCP_PORT}"
    PROXY_UDP_PORT="${PROXY_UDP_PORT:-$DEFAULT_PROXY_UDP_PORT}"
    PROXY_MODE="${PROXY_MODE:-$DEFAULT_PROXY_MODE}"
    DNS_HIJACK_ENABLE="${DNS_HIJACK_ENABLE:-$DEFAULT_DNS_HIJACK_ENABLE}"
    DNS_PORT="${DNS_PORT:-$DEFAULT_DNS_PORT}"
    MOBILE_INTERFACE="${MOBILE_INTERFACE:-$DEFAULT_MOBILE_INTERFACE}"
    WIFI_INTERFACE="${WIFI_INTERFACE:-$DEFAULT_WIFI_INTERFACE}"
    HOTSPOT_INTERFACE="${HOTSPOT_INTERFACE:-$DEFAULT_HOTSPOT_INTERFACE}"
    USB_INTERFACE="${USB_INTERFACE:-$DEFAULT_USB_INTERFACE}"
    PROXY_MOBILE="${PROXY_MOBILE:-$DEFAULT_PROXY_MOBILE}"
    PROXY_WIFI="${PROXY_WIFI:-$DEFAULT_PROXY_WIFI}"
    PROXY_HOTSPOT="${PROXY_HOTSPOT:-$DEFAULT_PROXY_HOTSPOT}"
    PROXY_USB="${PROXY_USB:-$DEFAULT_PROXY_USB}"
    PROXY_TCP="${PROXY_TCP:-$DEFAULT_PROXY_TCP}"
    PROXY_UDP="${PROXY_UDP:-$DEFAULT_PROXY_UDP}"
    PROXY_IPV6="${PROXY_IPV6:-$DEFAULT_PROXY_IPV6}"
    MARK_VALUE="${MARK_VALUE:-$DEFAULT_MARK_VALUE}"
    MARK_VALUE6="${MARK_VALUE6:-$DEFAULT_MARK_VALUE6}"
    TABLE_ID="${TABLE_ID:-$DEFAULT_TABLE_ID}"
    APP_PROXY_ENABLE="${APP_PROXY_ENABLE:-$DEFAULT_APP_PROXY_ENABLE}"
    PROXY_APPS_LIST="${PROXY_APPS_LIST:-$DEFAULT_PROXY_APPS_LIST}"
    BYPASS_APPS_LIST="${BYPASS_APPS_LIST:-$DEFAULT_BYPASS_APPS_LIST}"
    APP_PROXY_MODE="${APP_PROXY_MODE:-$DEFAULT_APP_PROXY_MODE}"
    BYPASS_CN_IP="${BYPASS_CN_IP:-$DEFAULT_BYPASS_CN_IP}"
    CN_IP_FILE="${CN_IP_FILE:-$DEFAULT_CN_IP_FILE}"
    CN_IPV6_FILE="${CN_IPV6_FILE:-$DEFAULT_CN_IPV6_FILE}"
    CN_IP_URL="${CN_IP_URL:-$DEFAULT_CN_IP_URL}"
    CN_IPV6_URL="${CN_IPV6_URL:-$DEFAULT_CN_IPV6_URL}"
    MAC_FILTER_ENABLE="${MAC_FILTER_ENABLE:-$DEFAULT_MAC_FILTER_ENABLE}"
    PROXY_MACS_LIST="${PROXY_MACS_LIST:-$DEFAULT_PROXY_MACS_LIST}"
    BYPASS_MACS_LIST="${BYPASS_MACS_LIST:-$DEFAULT_BYPASS_MACS_LIST}"
    MAC_PROXY_MODE="${MAC_PROXY_MODE:-$DEFAULT_MAC_PROXY_MODE}"
    SKIP_CHECK_FEATURE="${SKIP_CHECK_FEATURE:-$DEFAULT_SKIP_CHECK_FEATURE}"
    
    # FakeIP uses defaults, get_fakeip_range() reads from config.json
    FAKEIP_RANGE_V4="$DEFAULT_FAKEIP_RANGE_V4"
    FAKEIP_RANGE_V6="$DEFAULT_FAKEIP_RANGE_V6"
}

# Load FakeIP range from config.json if jq is available, otherwise use defaults
get_fakeip_range() {
    local jq_bin="$TOOLS_DIR/jq"
    
    # Try reading from config.json using jq
    if [ -x "$jq_bin" ] && [ -f "$CONFIG_FILE" ]; then
        local v4 v6
        v4=$("$jq_bin" -r '.dns.fakeip.inet4_range // empty' "$CONFIG_FILE" 2>/dev/null)
        v6=$("$jq_bin" -r '.dns.fakeip.inet6_range // empty' "$CONFIG_FILE" 2>/dev/null)
        
        [ -n "$v4" ] && FAKEIP_RANGE_V4="$v4"
        [ -n "$v6" ] && FAKEIP_RANGE_V6="$v6"
    fi
    
    # Log what we're using
    log_debug "FakeIP range: v4=$FAKEIP_RANGE_V4, v6=$FAKEIP_RANGE_V6"
}


# ==============================================================================
# [ Config Validation ]
# ==============================================================================

is_valid_int() {
    local val="$1"
    local min="$2"
    local max="$3"
    
    case "$val" in
        ''|*[!0-9]*) return 1 ;;
    esac
    
    if [ "$val" -ge "$min" ] && [ "$val" -le "$max" ]; then
        return 0
    fi
    return 1
}

validate_int_range() {
    local name="$1"
    local val="$2"
    local min="$3"
    local max="$4"
    
    if ! is_valid_int "$val" "$min" "$max"; then
        log_error "Invalid $name: $val (must be $min-$max)"
        return 1
    fi
    return 0
}

validate_flux_config() {
    log_info "Validating configuration..."
    
    local valid=1
    
    # Logging
    validate_int_range "LOG_ENABLE" "$LOG_ENABLE" 0 1 || valid=0
    validate_int_range "LOG_LEVEL" "$LOG_LEVEL" 0 3 || valid=0
    validate_int_range "LOG_MAX_SIZE" "$LOG_MAX_SIZE" 10240 104857600 || valid=0
    
    # Timeouts
    validate_int_range "CORE_TIMEOUT" "$CORE_TIMEOUT" 1 60 || valid=0
    validate_int_range "UPDATE_TIMEOUT" "$UPDATE_TIMEOUT" 1 300 || valid=0
    validate_int_range "RETRY_COUNT" "$RETRY_COUNT" 0 10 || valid=0
    validate_int_range "UPDATE_INTERVAL" "$UPDATE_INTERVAL" 60 31536000 || valid=0
    
    # Ports
    validate_int_range "PROXY_TCP_PORT" "$PROXY_TCP_PORT" 1 65535 || valid=0
    validate_int_range "PROXY_UDP_PORT" "$PROXY_UDP_PORT" 1 65535 || valid=0
    validate_int_range "DNS_PORT" "$DNS_PORT" 1 65535 || valid=0
    
    # Proxy Mode
    validate_int_range "PROXY_MODE" "$PROXY_MODE" 0 2 || valid=0
    validate_int_range "DNS_HIJACK_ENABLE" "$DNS_HIJACK_ENABLE" 0 2 || valid=0
    
    # Proxy Scope
    validate_int_range "PROXY_MOBILE" "$PROXY_MOBILE" 0 1 || valid=0
    validate_int_range "PROXY_WIFI" "$PROXY_WIFI" 0 1 || valid=0
    validate_int_range "PROXY_HOTSPOT" "$PROXY_HOTSPOT" 0 1 || valid=0
    validate_int_range "PROXY_USB" "$PROXY_USB" 0 1 || valid=0
    validate_int_range "PROXY_TCP" "$PROXY_TCP" 0 1 || valid=0
    validate_int_range "PROXY_UDP" "$PROXY_UDP" 0 1 || valid=0
    validate_int_range "PROXY_IPV6" "$PROXY_IPV6" 0 1 || valid=0
    
    # Internal Marks
    validate_int_range "MARK_VALUE" "$MARK_VALUE" 1 2147483647 || valid=0
    validate_int_range "MARK_VALUE6" "$MARK_VALUE6" 1 2147483647 || valid=0
    validate_int_range "TABLE_ID" "$TABLE_ID" 1 65535 || valid=0
    
    # Per-App Proxy
    validate_int_range "APP_PROXY_ENABLE" "$APP_PROXY_ENABLE" 0 1 || valid=0
    validate_int_range "APP_PROXY_MODE" "$APP_PROXY_MODE" 1 2 || valid=0
    
    # CN IP Bypass
    validate_int_range "BYPASS_CN_IP" "$BYPASS_CN_IP" 0 1 || valid=0
    
    # MAC Filter
    validate_int_range "MAC_FILTER_ENABLE" "$MAC_FILTER_ENABLE" 0 1 || valid=0
    validate_int_range "MAC_PROXY_MODE" "$MAC_PROXY_MODE" 1 2 || valid=0
    
    # Advanced
    validate_int_range "SKIP_CHECK_FEATURE" "$SKIP_CHECK_FEATURE" 0 1 || valid=0
    
    if [ "$valid" -eq 0 ]; then
        log_error "Configuration validation failed"
        return 1
    fi

    log_info "Configuration valid."
}
